<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Task Cups Prototype - Pollution Urgency</title>
<script src="https://cdn.jsdelivr.net/npm/p5@1.6.0/lib/p5.js"></script>
<style>
  body { margin: 0; background: #000; color: #fff; font-family: sans-serif; }
  #checklist { position: fixed; top: -30px; left: 10px; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 5px; display: none; }
  #toggleTextBtn, #toggleMobileBtn, #toggleSubtaskBtn {
    position: fixed; top: 10px; padding: 10px; background: #222; color: #fff; border: none; border-radius: 5px; cursor: pointer;
  }
  #toggleTextBtn { right: 10px; }
  #toggleMobileBtn { right: 200px; }
  #toggleSubtaskBtn { right: 350px; }
</style>
</head>
<body>
<div id="checklist">
  <strong>Setup Checklist</strong>
  <ul>
    <li id="cupsCreated">Cups created</li>
    <li id="particlesCreated">Particles created</li>
    <li id="animationRunning">Animation running</li>
    <li id="urgencyColor">Urgency color mapping</li>
  </ul>
</div>

<button id="toggleTextBtn">Hide Cup Titles & Deadlines</button>
<button id="toggleMobileBtn">Enable Mobile View</button>
<button id="toggleSubtaskBtn">Show Subtask Titles</button>

<script>
let cups = [];
let maxRipple = 60;
let showCupText = false;
let mobileView = false;
let showSubtaskTitles = false;
let touchStartTime = 0;
let longPressDuration = 500; // ms
let tappedParticle = null;

// --- Main Tasks ---
let mainTasks = [
  {
    title: "Bike to St. Catharines",
    deadline: "2025-10-10T18:42:00",
    subtasks: [
      "Wash Up",
      "Prep 2 sets of clothes",
      "Find Keys",
      "Start: Find and charge phone*high stress*",
      "Charge Headphones",
      "Bike to St. Catharines",
      "Check Job Route",
      "Check Job Picture",
      "Bike Ride Complete"
    ]
  },
  {
    title: "Pick Up Liam For Work",
    deadline: "2025-10-10T18:00:00",
    subtasks: [
      "Start: Drop Bicycle Off At Home*high stress*",
      "Drive To Liam's House",
      "On The Way To Client's House By 9:35am"
    ]
  },
  {
    title: "Return Home Safely",
    deadline: "2025-10-10T18:00:00",
    subtasks: [
      "Drop Liam Off",
      "Drive To Liam's House",
      "Start Returning Home By 11:25am*high stress*"
    ]
  },
  {
    title: "Do Car Related Work",
    deadline: "2025-10-10T18:00:00",
    subtasks: [
      "Call Doctor",
      "Start: Send e-mail from Service Ontario to Doctor*high stress*"
    ]
  },
  {
    title: "Start Reviewing Marsh's Work and Develop Steps",
    deadline: "2025-10-10T18:00:00",
    subtasks: [
      "Start: Open Google Drive, Gmail, and Remember Last Website*high stress*"
    ]
  }
];

// --- Load / Save ---
function loadCompletedState(){ let saved = localStorage.getItem('completedParticles'); return saved ? JSON.parse(saved) : []; }
function saveCompletedState(){ let completed = []; for(let cup of cups){ completed.push(cup.particles.map(p => p.completed)); } localStorage.setItem('completedParticles', JSON.stringify(completed)); }

// --- Cup Class ---
class Cup {
  constructor(x, y, w, h, title, deadline, color){
    this.pos = createVector(x, y);
    this.w = w;
    this.h = h;
    this.title = title;
    this.deadline = new Date(deadline);
    this.color = color;
    this.particles = [];
    this.deadlineTotal = this.deadline - new Date();
  }
  addParticle(name, completed=false, highStress=false){
    let particle = new Particle(random(this.pos.x,this.pos.x+this.w), random(this.pos.y,this.pos.y+this.h), name, this, completed, highStress);
    this.particles.push(particle);
  }
  update(){
    for(let p of this.particles) p.update();
    if(showCupText){
      fill(255);
      textAlign(CENTER);
      textSize(windowWidth < 600 ? 18 : 14);
      text(this.title, this.pos.x + this.w/2, this.pos.y - 10);
      text("Deadline: " + this.deadline.toLocaleString(), this.pos.x + this.w/2, this.pos.y + this.h + 15);
    }
  }
}

// --- Particle Class ---
class Particle {
  constructor(x, y, name, cup, completed=false, highStress=false){
    this.pos = createVector(x, y);
    this.vel = createVector(random(-1.2,1.2), random(-1.2,1.2)); // faster for visible collisions
    this.r = 0.1;
    this.g = random(0.5,1);
    this.alpha = 150;
    this.name = name;
    this.cup = cup;
    this.completed = completed;
    this.fallSpeed = 2;
    this.urgency = 0;
    this.showNameUntil = 0;
    this.highStress = highStress;
    if(highStress){ this.baseColor = color(255,0,0); this.vel.mult(1.5); } 
    else { this.baseColor = cup.color; }
    this.setSizes();
  }

  setSizes(){
    if(mobileView || windowWidth < 600){ this.visualSize = 24; this.touchSize = 48; } 
    else { this.visualSize = 12; this.touchSize = 12; }
  }

update(){
  // move particle
  if(!this.completed) this.pos.add(this.vel);

  // cup boundaries
  if(this.pos.x < this.cup.pos.x){ this.pos.x = this.cup.pos.x; this.vel.x*=-1; }
  if(this.pos.x > this.cup.pos.x + this.cup.w){ this.pos.x = this.cup.pos.x + this.cup.w; this.vel.x*=-1; }
  if(this.pos.y < this.cup.pos.y){ this.pos.y = this.cup.pos.y; this.vel.y*=-1; }
  if(this.pos.y > this.cup.pos.y + this.cup.h){ this.pos.y = this.cup.pos.y + this.cup.h; this.vel.y*=-1; }

  // urgency
  if(!this.completed){
    let now = new Date();
    let remaining = this.cup.deadline - now;
    let sourceUrgency = constrain(1 - remaining / this.cup.deadlineTotal, 0, 1);
    this.urgency += (sourceUrgency - this.urgency) * 0.02;

    // spread urgency to nearby particles
    for(let other of this.cup.particles){
      if(!other.completed && other!==this && dist(this.pos.x,this.pos.y,other.pos.x,other.pos.y)<50){
        other.urgency += (this.urgency-other.urgency)*0.01;
        other.urgency = constrain(other.urgency,0,1);
      }
    }

    // --------- high stress collision & push ----------
    if(this.highStress){
      // stress factor decays if completed
      let stressFactor = this.completed ? max(0, 1 - (millis()%1000)/1000) : 1;

      for(let other of this.cup.particles){
        if(other === this || other.completed) continue;

        let myRadius = this.visualSize * 0.5;
        let otherRadius = other.visualSize * 0.5;
        let minDist = myRadius + otherRadius + 2;
        let d = dist(this.pos.x,this.pos.y,other.pos.x,other.pos.y);

        // calculate speed multiplier based on high-stress particle size
        let speedMultiplier = 0.05 * this.visualSize; // tweak 0.05 as needed

        if(d === 0){
          other.pos.add(createVector(random(-1,1), random(-1,1)).mult(stressFactor * speedMultiplier));
          other.vel.add(createVector(random(-0.5,0.5), random(-0.5,0.5)).mult(stressFactor * speedMultiplier));
        } else if(d < minDist){
          let overlap = (minDist - d);
          let dir = p5.Vector.sub(other.pos,this.pos).normalize();
          other.pos.add(dir.copy().mult((overlap * 0.75 + 0.5) * stressFactor * speedMultiplier));
          other.vel.add(dir.copy().mult((2.5 + overlap * 0.2) * stressFactor * speedMultiplier));
        }
      }
    }
    // -----------------------------------------------
    this.color = lerpColor(this.baseColor, color(255,0,0), this.urgency);
  }

  // ripple
  if(!this.completed){
    blendMode(ADD);
    noFill();
    stroke(this.color.levels[0], this.color.levels[1], this.color.levels[2], this.alpha);
    strokeWeight(2);
    ellipse(this.pos.x, this.pos.y, this.r*2);
    this.r += this.g * (this.highStress ? 1.5 : 1);
    this.alpha = map(this.r,0,maxRipple,150,0);
    if(this.r>maxRipple){ this.r=0.1; this.alpha=150; }
    blendMode(NORMAL);
  }

  // draw particle
  noStroke();
  fill(this.completed?"green":this.color);
  let targetY = this.completed?this.cup.pos.y+this.cup.h-6:this.pos.y;
  if(this.completed && this.pos.y<targetY){ this.pos.y+=this.fallSpeed; if(this.pos.y>targetY)this.pos.y=targetY; }
  ellipse(this.pos.x,this.pos.y,this.visualSize);

  // show titles: mobile tap, toggle, or high-urgency/high-stress
  if((mobileView && millis()<this.showNameUntil) || showSubtaskTitles || this.highStress || this.urgency>0.8){
    fill((this.highStress || this.urgency>0.8)?"red":"white");
    textAlign(CENTER);
    textSize(16);
    text(this.name,this.pos.x,this.pos.y-25);
  }
}


  toggleCompletion(){ this.completed=!this.completed; if(!this.completed)this.urgency=0; saveCompletedState(); }
}

// --- Setup ---
function setup(){
  createCanvas(windowWidth, windowHeight);
  background(0);
  let startX = 150, startY = 150, spacingX = 250, spacingY = 250;
  let cupsPerRow = 3;
  let completedState = loadCompletedState();
  
  let cupColors = [
    color(255,128,0),
    color(0,200,255),
    color(255,0,255),
    color(128,0,255),
    color(25,100,255),
    color(0,255,128)
  ];
  
  for(let i=0;i<mainTasks.length;i++){
    let t = mainTasks[i];
    let col = i % cupsPerRow;
    let row = Math.floor(i / cupsPerRow);
    let x = startX + col * spacingX;
    let y = startY + row * spacingY;
    
    let cup = new Cup(x, y, 150, 150, t.title, t.deadline, cupColors[i % cupColors.length]);
    
    t.subtasks.forEach((taskName,idx)=>{
      let completed = completedState[i] ? completedState[i][idx] : false;
      let highStress = false;
      if(taskName.includes("*high stress*")) {
        highStress = true;
        taskName = taskName.split("*")[0];
      }
      cup.addParticle(taskName, completed, highStress);
    });
    cups.push(cup);
  }

  document.getElementById("cupsCreated").style.color="lime";
  document.getElementById("particlesCreated").style.color="lime"; // fixed typo
  document.getElementById("urgencyColor").style.color="lime";

  // Buttons
  document.getElementById("toggleTextBtn").addEventListener("click",()=>{
    showCupText=!showCupText;
    document.getElementById("checklist").style.display=showCupText?"block":"none";
    document.getElementById("toggleTextBtn").innerText = showCupText?"Hide Cup Titles & Deadlines":"Show Cup Titles & Deadlines";
  });

  document.getElementById("toggleMobileBtn").addEventListener("click",()=>{
    mobileView=!mobileView;
    cups.forEach(cup=>cup.particles.forEach(p=>p.setSizes()));
    document.getElementById("toggleMobileBtn").innerText = mobileView?"Disable Mobile View":"Enable Mobile View";
  });

  document.getElementById("toggleSubtaskBtn").addEventListener("click",()=>{
    showSubtaskTitles=!showSubtaskTitles;
    document.getElementById("toggleSubtaskBtn").innerText = showSubtaskTitles?"Hide Subtask Titles":"Show Subtask Titles";
  });
}

// --- Draw ---
function draw(){
  background(0,20);
  for(let cup of cups) cup.update();
  document.getElementById("animationRunning").style.color="lime";
}

// --- Touch ---
function touchStarted(){
  for(let cup of cups){
    for(let p of cup.particles){
      if(dist(touchX,touchY,p.pos.x,p.pos.y)<p.touchSize/2){
        tappedParticle=p;
        touchStartTime=millis();
        return false;
      }
    }
  }
  return true;
}

function touchEnded(){
  if(!tappedParticle) return true;
  let duration = millis() - touchStartTime;
  tappedParticle.toggleCompletion();
  if(mobileView && duration<longPressDuration) tappedParticle.showNameUntil=millis()+1000;
  tappedParticle=null;
  return false;
}

// --- Mouse ---
function mousePressed(){
  for(let cup of cups){
    for(let p of cup.particles){
      if(dist(mouseX,mouseY,p.pos.x,p.pos.y)<p.touchSize/2){ p.completed=true; saveCompletedState(); }
    }
  }
}
function mousePressedRight(e){
  e.preventDefault();
  for(let cup of cups){
    for(let p of cup.particles){
      if(dist(mouseX,mouseY,p.pos.x,p.pos.y)<p.touchSize/2){ p.completed=false; p.urgency=0; saveCompletedState(); }
    }
  }
  return false;
}
document.addEventListener("contextmenu", mousePressedRight);
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Task Cups Prototype - Pollution Urgency</title>
<script src="https://cdn.jsdelivr.net/npm/p5@1.6.0/lib/p5.js"></script>
<style>
  body { margin: 0; background: #000; color: #fff; font-family: sans-serif; }
  #checklist { position: fixed; top: -30px; left: 10px; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 5px; display: none; }
  #toggleTextBtn, #toggleMobileBtn, #toggleSubtaskBtn {
    position: fixed; top: 10px; padding: 10px; background: #222; color: #fff; border: none; border-radius: 5px; cursor: pointer;
  }
  #toggleTextBtn { right: 10px; }
  #toggleMobileBtn { right: 200px; }
  #toggleSubtaskBtn { right: 350px; }
</style>
</head>
<body>
<div id="checklist">
  <strong>Setup Checklist</strong>
  <ul>
    <li id="cupsCreated">Cups created</li>
    <li id="particlesCreated">Particles created</li>
    <li id="animationRunning">Animation running</li>
    <li id="urgencyColor">Urgency color mapping</li>
  </ul>
</div>

<button id="toggleTextBtn">Hide Cup Titles & Deadlines</button>
<button id="toggleMobileBtn">Enable Mobile View</button>
<button id="toggleSubtaskBtn">Show Subtask Titles</button>

<script>
let cups = [];
let maxRipple = 60;
let showCupText = false;
let mobileView = false;
let showSubtaskTitles = false;
let touchStartTime = 0;
let longPressDuration = 500; // ms
let tappedParticle = null;

// --- Main Tasks ---
let mainTasks = [
  {
    title: "Bike to St. Catharines",
    deadline: "2025-10-10T18:42:00",
    subtasks: [
      "Wash Up",
      "Prep 2 sets of clothes",
      "Find Keys",
      "Start: Find and charge phone*high stress*",
      "Charge Headphones",
      "Bike to St. Catharines",
      "Check Job Route",
      "Check Job Picture",
      "Bike Ride Complete"
    ]
  },
  {
    title: "Pick Up Liam For Work",
    deadline: "2025-10-10T18:00:00",
    subtasks: [
      "Start: Drop Bicycle Off At Home*high stress*",
      "Drive To Liam's House",
      "On The Way To Client's House By 9:35am"
    ]
  },
  {
    title: "Return Home Safely",
    deadline: "2025-10-10T18:00:00",
    subtasks: [
      "Drop Liam Off",
      "Drive To Liam's House",
      "Start Returning Home By 11:25am*high stress*"
    ]
  },
  {
    title: "Do Car Related Work",
    deadline: "2025-10-10T18:00:00",
    subtasks: [
      "Call Doctor",
      "Start: Send e-mail from Service Ontario to Doctor*high stress*"
    ]
  },
  {
    title: "Start Reviewing Marsh's Work and Develop Steps",
    deadline: "2025-10-10T18:00:00",
    subtasks: [
      "Start: Open Google Drive, Gmail, and Remember Last Website*high stress*"
    ]
  }
];

// --- Load / Save ---
function loadCompletedState(){ let saved = localStorage.getItem('completedParticles'); return saved ? JSON.parse(saved) : []; }
function saveCompletedState(){ let completed = []; for(let cup of cups){ completed.push(cup.particles.map(p => p.completed)); } localStorage.setItem('completedParticles', JSON.stringify(completed)); }

// --- Cup Class ---
class Cup {
  constructor(x, y, w, h, title, deadline, color){
    this.pos = createVector(x, y);
    this.w = w;
    this.h = h;
    this.title = title;
    this.deadline = new Date(deadline);
    this.color = color;
    this.particles = [];
    this.deadlineTotal = this.deadline - new Date();
  }
  addParticle(name, completed=false, highStress=false){
    let particle = new Particle(random(this.pos.x,this.pos.x+this.w), random(this.pos.y,this.pos.y+this.h), name, this, completed, highStress);
    this.particles.push(particle);
  }
  update(){
    for(let p of this.particles) p.update();
    if(showCupText){
      fill(255);
      textAlign(CENTER);
      textSize(windowWidth < 600 ? 18 : 14);
      text(this.title, this.pos.x + this.w/2, this.pos.y - 10);
      text("Deadline: " + this.deadline.toLocaleString(), this.pos.x + this.w/2, this.pos.y + this.h + 15);
    }
  }
}

// --- Particle Class ---
class Particle {
  constructor(x, y, name, cup, completed=false, highStress=false){
    this.pos = createVector(x, y);
    this.vel = createVector(random(-1.2,1.2), random(-1.2,1.2)); // faster for visible collisions
    this.r = 0.1;
    this.g = random(0.5,1);
    this.alpha = 150;
    this.name = name;
    this.cup = cup;
    this.completed = completed;
    this.fallSpeed = 2;
    this.urgency = 0;
    this.showNameUntil = 0;
    this.highStress = highStress;
    if(highStress){ this.baseColor = color(255,0,0); this.vel.mult(1.5); } 
    else { this.baseColor = cup.color; }
    this.setSizes();
  }

  setSizes(){
    if(mobileView || windowWidth < 600){ this.visualSize = 24; this.touchSize = 48; } 
    else { this.visualSize = 12; this.touchSize = 12; }
  }

update(){
  // move particle
  if(!this.completed) this.pos.add(this.vel);

  // cup boundaries
  if(this.pos.x < this.cup.pos.x){ this.pos.x = this.cup.pos.x; this.vel.x*=-1; }
  if(this.pos.x > this.cup.pos.x + this.cup.w){ this.pos.x = this.cup.pos.x + this.cup.w; this.vel.x*=-1; }
  if(this.pos.y < this.cup.pos.y){ this.pos.y = this.cup.pos.y; this.vel.y*=-1; }
  if(this.pos.y > this.cup.pos.y + this.cup.h){ this.pos.y = this.cup.pos.y + this.cup.h; this.vel.y*=-1; }

  // urgency
  if(!this.completed){
    let now = new Date();
    let remaining = this.cup.deadline - now;
    let sourceUrgency = constrain(1 - remaining / this.cup.deadlineTotal, 0, 1);
    this.urgency += (sourceUrgency - this.urgency) * 0.02;

    // spread urgency to nearby particles
    for(let other of this.cup.particles){
      if(!other.completed && other!==this && dist(this.pos.x,this.pos.y,other.pos.x,other.pos.y)<50){
        other.urgency += (this.urgency-other.urgency)*0.01;
        other.urgency = constrain(other.urgency,0,1);
      }
    }

    // --------- high stress collision & push ----------
    if(this.highStress){
      // stress factor decays if completed
      let stressFactor = this.completed ? max(0, 1 - (millis()%1000)/1000) : 1;

      for(let other of this.cup.particles){
        if(other === this || other.completed) continue;

        let myRadius = this.visualSize * 0.5;
        let otherRadius = other.visualSize * 0.5;
        let minDist = myRadius + otherRadius + 2;
        let d = dist(this.pos.x,this.pos.y,other.pos.x,other.pos.y);

        // calculate speed multiplier based on high-stress particle size
        let speedMultiplier = 0.05 * this.visualSize; // tweak 0.05 as needed

        if(d === 0){
          other.pos.add(createVector(random(-1,1), random(-1,1)).mult(stressFactor * speedMultiplier));
          other.vel.add(createVector(random(-0.5,0.5), random(-0.5,0.5)).mult(stressFactor * speedMultiplier));
        } else if(d < minDist){
          let overlap = (minDist - d);
          let dir = p5.Vector.sub(other.pos,this.pos).normalize();
          other.pos.add(dir.copy().mult((overlap * 0.75 + 0.5) * stressFactor * speedMultiplier));
          other.vel.add(dir.copy().mult((2.5 + overlap * 0.2) * stressFactor * speedMultiplier));
        }
      }
    }
    // -----------------------------------------------
    this.color = lerpColor(this.baseColor, color(255,0,0), this.urgency);
  }

  // ripple
  if(!this.completed){
    blendMode(ADD);
    noFill();
    stroke(this.color.levels[0], this.color.levels[1], this.color.levels[2], this.alpha);
    strokeWeight(2);
    ellipse(this.pos.x, this.pos.y, this.r*2);
    this.r += this.g * (this.highStress ? 1.5 : 1);
    this.alpha = map(this.r,0,maxRipple,150,0);
    if(this.r>maxRipple){ this.r=0.1; this.alpha=150; }
    blendMode(NORMAL);
  }

  // draw particle
  noStroke();
  fill(this.completed?"green":this.color);
  let targetY = this.completed?this.cup.pos.y+this.cup.h-6:this.pos.y;
  if(this.completed && this.pos.y<targetY){ this.pos.y+=this.fallSpeed; if(this.pos.y>targetY)this.pos.y=targetY; }
  ellipse(this.pos.x,this.pos.y,this.visualSize);

  // show titles: mobile tap, toggle, or high-urgency/high-stress
  if((mobileView && millis()<this.showNameUntil) || showSubtaskTitles || this.highStress || this.urgency>0.8){
    fill((this.highStress || this.urgency>0.8)?"red":"white");
    textAlign(CENTER);
    textSize(16);
    text(this.name,this.pos.x,this.pos.y-25);
  }
}


  toggleCompletion(){ this.completed=!this.completed; if(!this.completed)this.urgency=0; saveCompletedState(); }
}

// --- Setup ---
function setup(){
  createCanvas(windowWidth, windowHeight);
  background(0);
  let startX = 150, startY = 150, spacingX = 250, spacingY = 250;
  let cupsPerRow = 3;
  let completedState = loadCompletedState();
  
  let cupColors = [
    color(255,128,0),
    color(0,200,255),
    color(255,0,255),
    color(128,0,255),
    color(25,100,255),
    color(0,255,128)
  ];
  
  for(let i=0;i<mainTasks.length;i++){
    let t = mainTasks[i];
    let col = i % cupsPerRow;
    let row = Math.floor(i / cupsPerRow);
    let x = startX + col * spacingX;
    let y = startY + row * spacingY;
    
    let cup = new Cup(x, y, 150, 150, t.title, t.deadline, cupColors[i % cupColors.length]);
    
    t.subtasks.forEach((taskName,idx)=>{
      let completed = completedState[i] ? completedState[i][idx] : false;
      let highStress = false;
      if(taskName.includes("*high stress*")) {
        highStress = true;
        taskName = taskName.split("*")[0];
      }
      cup.addParticle(taskName, completed, highStress);
    });
    cups.push(cup);
  }

  document.getElementById("cupsCreated").style.color="lime";
  document.getElementById("particlesCreated").style.color="lime"; // fixed typo
  document.getElementById("urgencyColor").style.color="lime";

  // Buttons
  document.getElementById("toggleTextBtn").addEventListener("click",()=>{
    showCupText=!showCupText;
    document.getElementById("checklist").style.display=showCupText?"block":"none";
    document.getElementById("toggleTextBtn").innerText = showCupText?"Hide Cup Titles & Deadlines":"Show Cup Titles & Deadlines";
  });

  document.getElementById("toggleMobileBtn").addEventListener("click",()=>{
    mobileView=!mobileView;
    cups.forEach(cup=>cup.particles.forEach(p=>p.setSizes()));
    document.getElementById("toggleMobileBtn").innerText = mobileView?"Disable Mobile View":"Enable Mobile View";
  });

  document.getElementById("toggleSubtaskBtn").addEventListener("click",()=>{
    showSubtaskTitles=!showSubtaskTitles;
    document.getElementById("toggleSubtaskBtn").innerText = showSubtaskTitles?"Hide Subtask Titles":"Show Subtask Titles";
  });
}

// --- Draw ---
function draw(){
  background(0,20);
  for(let cup of cups) cup.update();
  document.getElementById("animationRunning").style.color="lime";
}

// --- Touch ---
function touchStarted(){
  for(let cup of cups){
    for(let p of cup.particles){
      if(dist(touchX,touchY,p.pos.x,p.pos.y)<p.touchSize/2){
        tappedParticle=p;
        touchStartTime=millis();
        return false;
      }
    }
  }
  return true;
}

function touchEnded(){
  if(!tappedParticle) return true;
  let duration = millis() - touchStartTime;
  tappedParticle.toggleCompletion();
  if(mobileView && duration<longPressDuration) tappedParticle.showNameUntil=millis()+1000;
  tappedParticle=null;
  return false;
}

// --- Mouse ---
function mousePressed(){
  for(let cup of cups){
    for(let p of cup.particles){
      if(dist(mouseX,mouseY,p.pos.x,p.pos.y)<p.touchSize/2){ p.completed=true; saveCompletedState(); }
    }
  }
}
function mousePressedRight(e){
  e.preventDefault();
  for(let cup of cups){
    for(let p of cup.particles){
      if(dist(mouseX,mouseY,p.pos.x,p.pos.y)<p.touchSize/2){ p.completed=false; p.urgency=0; saveCompletedState(); }
    }
  }
  return false;
}
document.addEventListener("contextmenu", mousePressedRight);
</script>
</body>
</html>
