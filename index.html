<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Task Cups Prototype - Pollution Urgency</title>
<script src="https://cdn.jsdelivr.net/npm/p5@1.6.0/lib/p5.js"></script>
<style>
  html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    background: #000;
    font-family: sans-serif;
    -webkit-user-select: none;
    -webkit-touch-callout: none;
  }
  canvas { 
    display: block; 
    width: 100vw; 
    height: 100vh; 
    position: absolute; 
    top: 0; 
    left: 0; 
    z-index: 0; 
  }
  #checklist { 
    position: fixed; 
    top: -30px; 
    left: 10px; 
    background: rgba(0,0,0,0.7); 
    padding: 10px; 
    border-radius: 5px; 
    display: none; 
    z-index: 10;
  }
  #toggleTextBtn, #toggleMobileBtn, #toggleSubtaskBtn {
    position: fixed; 
    top: 10px; 
    padding: 10px; 
    background: #222; 
    color: #fff; 
    border: none; 
    border-radius: 5px; 
    cursor: pointer;
    z-index: 20;
  }
  #toggleTextBtn { right: 10px; }
  #toggleMobileBtn { right: 200px; }
  #toggleSubtaskBtn { right: 350px; }
</style>
</head>
<body>
<div id="checklist">
  <strong>Setup Checklist</strong>
  <ul>
    <li id="cupsCreated">Cups created</li>
    <li id="particlesCreated">Particles created</li>
    <li id="animationRunning">Animation running</li>
    <li id="urgencyColor">Urgency color mapping</li>
  </ul>
</div>

<button id="toggleTextBtn">Hide Cup Titles & Deadlines</button>
<button id="toggleMobileBtn">Enable Mobile View</button>
<button id="toggleSubtaskBtn">Show Subtask Titles</button>

<script>
let cups = [];
let maxRipple = 60;
let showCupText = false;
let mobileView = false;
let showSubtaskTitles = false;
let touchStartTime = 0;
let longPressDuration = 500; // ms
let tappedParticle = null;

// --- Main Tasks --- (your tasks array remains unchanged)
let mainTasks = [
  // ... paste your full mainTasks array here as in your original code
];

// --- Load / Save ---
function safeStorageAvailable() {
  try { localStorage.setItem("test","1"); localStorage.removeItem("test"); return true; }
  catch(e){ return false; }
}
let storageEnabled = safeStorageAvailable();
function loadCompletedState(){ if(!storageEnabled) return []; let saved = localStorage.getItem('completedParticles'); return saved?JSON.parse(saved):[]; }
function saveCompletedState(){ if(!storageEnabled) return; let completed=[]; for(let cup of cups){ completed.push(cup.particles.map(p=>p.completed)); } localStorage.setItem('completedParticles',JSON.stringify(completed)); }

// --- Cup Class ---
class Cup {
  constructor(x, y, w, h, title, deadline, color){
    this.pos = createVector(x, y);
    this.w = w; this.h = h;
    this.title = title;
    this.deadline = new Date(deadline);
    this.color = color;
    this.particles = [];
    this.deadlineTotal = this.deadline - new Date();
    this.currentTitleIndex = 0;
    this.titleFade = 0;
    this.titleDirection = 1;
    this.titleSpeed = 2;
  }
  addParticle(name, completed=false, highStress=false){
    let particle = new Particle(random(this.pos.x,this.pos.x+this.w), random(this.pos.y,this.pos.y+this.h), name, this, completed, highStress);
    this.particles.push(particle);
  }
  update(){
    // Subtask title cycling (skip high-stress)
    if(showSubtaskTitles && this.particles.length>0){
      let normalParticles = this.particles.filter(p=>!p.highStress);
      if(normalParticles.length>0){
        let p = normalParticles[this.currentTitleIndex%normalParticles.length];
        this.titleFade += this.titleDirection * this.titleSpeed;
        if(this.titleFade>=255){ this.titleFade=255; this.titleDirection=-1; }
        else if(this.titleFade<=0){ this.titleFade=0; this.titleDirection=1; this.currentTitleIndex=(this.currentTitleIndex+1)%normalParticles.length; }
        fill(255,this.titleFade); textAlign(CENTER); textSize(16); text(p.name,p.pos.x,p.pos.y-25);
      }
    }

    for(let p of this.particles) p.update();

    if(showCupText){
      fill(255); textAlign(CENTER); textSize(windowWidth<600?18:14);
      text(this.title, this.pos.x+this.w/2, this.pos.y-10);
      text("Deadline: "+this.deadline.toLocaleString(), this.pos.x+this.w/2, this.pos.y+this.h+15);
    }
  }
}

// --- Particle Class ---
class Particle {
  constructor(x,y,name,cup,completed=false,highStress=false){
    this.pos=createVector(x,y);
    this.vel=createVector(random(-1.2,1.2),random(-1.2,1.2));
    this.r=0.1; this.g=random(0.5,1); this.alpha=150;
    this.name=name; this.cup=cup; this.completed=completed; this.fallSpeed=2;
    this.urgency=0; this.showNameUntil=0; this.highStress=highStress;
    this.baseColor=highStress?color(255,0,0):cup.color;
    if(highStress) this.vel.mult(1.5);
    this.setSizes();
  }
  setSizes(){ if(mobileView||windowWidth<600){ this.visualSize=24; this.touchSize=48; } else { this.visualSize=12; this.touchSize=12; } }
  update(){
    if(!this.completed) this.pos.add(this.vel);
    // cup boundaries
    if(this.pos.x<this.cup.pos.x){ this.pos.x=this.cup.pos.x; this.vel.x*=-1; }
    if(this.pos.x>this.cup.pos.x+this.cup.w){ this.pos.x=this.cup.pos.x+this.cup.w; this.vel.x*=-1; }
    if(this.pos.y<this.cup.pos.y){ this.pos.y=this.cup.pos.y; this.vel.y*=-1; }
    if(this.pos.y>this.cup.pos.y+this.cup.h){ this.pos.y=this.cup.pos.y+this.cup.h; this.vel.y*=-1; }

    // urgency
    if(!this.completed){
      let now=new Date();
      let remaining=this.cup.deadline-now;
      let sourceUrgency=constrain(1-remaining/this.cup.deadlineTotal,0,1);
      this.urgency+=(sourceUrgency-this.urgency)*0.02;
      for(let other of this.cup.particles){
        if(!other.completed && other!==this && dist(this.pos.x,this.pos.y,other.pos.x,other.pos.y)<50){
          other.urgency+=(this.urgency-other.urgency)*0.01; other.urgency=constrain(other.urgency,0,1);
        }
      }
      if(this.highStress){
        let stressFactor=this.completed?max(0,1-(millis()%1000)/1000):1;
        for(let other of this.cup.particles){
          if(other===this||other.completed) continue;
          let myRadius=this.visualSize*0.75, otherRadius=other.visualSize*0.5;
          let minDist=myRadius+otherRadius+2, d=dist(this.pos.x,this.pos.y,other.pos.x,other.pos.y);
          let speedMultiplier=0.05*this.visualSize;
          if(d===0){
            other.pos.add(createVector(random(-1,1),random(-1,1)).mult(stressFactor*speedMultiplier));
            other.vel.add(createVector(random(-0.5,0.5),random(-0.5,0.5)).mult(stressFactor*speedMultiplier));
          } else if(d<minDist){
            let overlap=minDist-d;
            let dir=p5.Vector.sub(other.pos,this.pos).normalize();
            other.pos.add(dir.copy().mult((overlap*0.75+0.5)*stressFactor*speedMultiplier));
            other.vel.add(dir.copy().mult((2.5+overlap*0.2)*stressFactor*speedMultiplier));
          }
          if(this.completed){
            let defaultSpeed=1.2;
            other.vel.x=lerp(other.vel.x,constrain(other.vel.x,-defaultSpeed,defaultSpeed),0.05);
            other.vel.y=lerp(other.vel.y,constrain(other.vel.y,-defaultSpeed,defaultSpeed),0.05);
          }
        }
      }
      this.color=lerpColor(this.baseColor,color(255,0,0),this.urgency);
    }

    // ripple Safari-safe
    push();
    blendMode(ADD);
    noFill();
    stroke(this.color.levels[0],this.color.levels[1],this.color.levels[2],this.alpha);
    strokeWeight(2);
    ellipse(this.pos.x,this.pos.y,this.r*2);
    pop();
    this.r+=this.g*(this.highStress?1.5:1);
    this.alpha=map(this.r,0,maxRipple,150,0);
    if(this.r>maxRipple){ this.r=0.1; this.alpha=150; }

    // draw particle
    noStroke();
    fill(this.completed?"green":this.color);
    let targetY=this.completed?this.cup.pos.y+this.cup.h-6:this.pos.y;
    if(this.completed && this.pos.y<targetY){ this.pos.y+=this.fallSpeed; if(this.pos.y>targetY)this.pos.y=targetY; }
    ellipse(this.pos.x,this.pos.y,this.visualSize);

    // show titles
    if((mobileView && millis()<this.showNameUntil) || this.highStress || this.urgency>0.8){
      fill((this.highStress||this.urgency>0.8)?"red":"white");
      textAlign(CENTER);
      textSize(16);
      text(this.name,this.pos.x,this.pos.y-25);
    }
  }
  toggleCompletion(){ this.completed=!this.completed; if(!this.completed) this.urgency=0; saveCompletedState(); }
}

// --- Setup ---
function setup(){
  let cnv = createCanvas(window.innerWidth, window.innerHeight);
  cnv.style('display','block'); cnv.style('position','absolute'); cnv.style('top','0'); cnv.style('left','0');
  frameRate(60);
  background(0);

  let startX=150,startY=150,spacingX=250,spacingY=250,cupsPerRow=3;
  let completedState=loadCompletedState();
  let cupColors=[color(255,128,0),color(0,200,255),color(255,0,255),color(128,0,255),color(25,100,255),color(0,255,128)];

  for(let i=0;i<mainTasks.length;i++){
    let t=mainTasks[i];
    let col=i%cupsPerRow,row=Math.floor(i/cupsPerRow);
    let x=startX+col*spacingX, y=startY+row*spacingY;
    let cup=new Cup(x,y,150,150,t.title,t.deadline,cupColors[i%cupColors.length]);

    t.subtasks.forEach((taskName,idx)=>{
      let completed=completedState[i]?completedState[i][idx]:false;
      let highStress=false;
      if(taskName.includes("*high stress*")){ highStress=true; taskName=taskName.split("*")[0]; }
      cup.addParticle(taskName,completed,highStress);
    });
    cups.push(cup);
  }

  document.getElementById("cupsCreated").style.color="lime";
  document.getElementById("particlesCreated").style.color="lime"; 
  document.getElementById("urgencyColor").style.color="lime";

  document.getElementById("toggleTextBtn").addEventListener("click",()=>{
    showCupText=!showCupText;
    document.getElementById("checklist").style.display=showCupText?"block":"none";
    document.getElementById("toggleTextBtn").innerText = showCupText?"Hide Cup Titles & Deadlines":"Show Cup Titles & Deadlines";
  });

  document.getElementById("toggleMobileBtn").addEventListener("click",()=>{
    mobileView=!mobileView;
    cups.forEach(cup=>cup.particles.forEach(p=>p.setSizes()));
    document.getElementById("toggleMobileBtn").innerText = mobileView?"Disable Mobile View":"Enable Mobile View";
  });

  document.getElementById("toggleSubtaskBtn").addEventListener("click",()=>{
    showSubtaskTitles=!showSubtaskTitles;
    document.getElementById("toggleSubtaskBtn").innerText = showSubtaskTitles?"Hide Subtask Titles":"Show Subtask Titles";
  });
}

// --- Draw ---
function draw(){
  background(0,20);
  for(let cup of cups) cup.update();
  document.getElementById("animationRunning").style.color="lime";
}

// --- Touch ---
function touchStarted(){
  for(let cup of cups){
    for(let p of cup.particles){
      if(dist(touchX,touchY,p.pos.x,p.pos.y)<p.touchSize/2){
        tappedParticle=p;
        touchStartTime=millis();
        return true;
      }
    }
  }
  return true;
}
function touchEnded(){
  if(!tappedParticle) return true;
  let duration=millis()-touchStartTime;
  tappedParticle.toggleCompletion();
  if(mobileView && duration<longPressDuration) tappedParticle.showNameUntil=millis()+1000;
  tappedParticle=null;
  return true;
}

// --- Mouse ---
function mousePressed(){
  for(let cup of cups){
    for(let p of cup.particles){
      if(dist(mouseX,mouseY,p.pos.x,p.pos.y)<p.touchSize/2){ p.completed=true; saveCompletedState(); }
    }
  }
}

function mousePressedRight(e){
  e.preventDefault();
  for(let cup of cups){
    for(let p of cup.particles){
      if(dist(mouseX,mouseY,p.pos.x,p.pos.y)<p.touchSize/2){ p.completed=false; p.urgency=0; saveCompletedState(); }
    }
  }
  return false;
}
document.addEventListener("contextmenu", mousePressedRight);

// --- Window resize ---
function windowResized(){
  resizeCanvas(window.innerWidth, window.innerHeight);
  cups.forEach(cup=>cup.particles.forEach(p=>p.setSizes()));
}
</script>
</body>
</html>
